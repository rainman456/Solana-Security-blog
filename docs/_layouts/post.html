<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: " en" }}">

{% include head.html %}

<body>

  {% include header.html %}

  <main class="page-content" aria-label="Content">
    <div class="wrapper">
      <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

        <!-- 1. Post Header & Meta -->
        <header class="post-header">
          <h1 class="post-title p-name" itemprop="name headline">{{ page.title | escape }}</h1>
          <p class="post-meta">
            {%- if page.difficulty -%}
            <span class="difficulty-badge {{ page.difficulty | downcase }}">{{ page.difficulty }}</span>
            {%- endif -%}
            {%- if page.risk_level -%}
            <span class="risk-badge {{ page.risk_level | downcase }}"
              style="margin-left: 0.5rem; font-size: 0.8em; padding: 2px 8px; border-radius: 4px; border: 1px solid currentColor;">{{
              page.risk_level }} Risk</span>
            {%- endif -%}
            <time class="dt-published" datetime="{{ page.date | date_to_xmlschema }}" itemprop="datePublished"
              style="margin-left: 1rem;">
              {{ page.date | date: "%b %-d, %Y" }}
            </time>
          </p>
        </header>

        <!-- 2. "The Vulnerability in Plain English" Hero -->
        {% if page.description %}
        <div class="hero-summary">
          <h3>The Vulnerability in Plain English</h3>
          <p>{{ page.description }}</p>
        </div>
        {% endif %}

        <!-- 3. Automatic Diagram Injection -->
        <!-- Tries to load SVG matching the slug. Uses onerror to hide if not found. -->
        <div class="auto-diagram-container">
          {% assign diagram_name = page.diagram | default: page.slug %}
          <div class="auto-diagram" style="display: none;" id="diagram-wrapper">
            <img src="{{ '/assets/images/diagrams/' | append: diagram_name | append: '.svg' | relative_url }}"
              alt="Vulnerability Diagram" onload="document.getElementById('diagram-wrapper').style.display='block'"
              onerror="this.style.display='none'; document.getElementById('diagram-wrapper').style.display='none'">
          </div>
        </div>

        <!-- 4. Side-by-Side Code Comparison (Layout Controlled) -->
        <!-- 4. Side-by-Side Code Comparison (Layout Controlled) -->
        {% if page.vulnerable_code and page.secure_code %}
        {% include code-compare.html %}
        {% endif %}

        <div class="post-content e-content" itemprop="articleBody">
          {% if page.impact or page.recommendation %}
          <div class="impact-grid"
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
            {% if page.impact %}
            <div class="impact-box"
              style="background: rgba(239, 68, 68, 0.05); border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0 8px 8px 0;">
              <h4 style="color: #ef4444; margin-top: 0; margin-bottom: 0.5rem;">üí• Impact</h4>
              <p style="margin: 0; font-size: 0.95rem;">{{ page.impact }}</p>
            </div>
            {% endif %}
            {% if page.recommendation %}
            <div class="rec-box"
              style="background: rgba(34, 197, 94, 0.05); border-left: 4px solid #22c55e; padding: 1rem; border-radius: 0 8px 8px 0;">
              <h4 style="color: #22c55e; margin-top: 0; margin-bottom: 0.5rem;">üõ°Ô∏è Recommendation</h4>
              <p style="margin: 0; font-size: 0.95rem;">{{ page.recommendation }}</p>
            </div>
            {% endif %}
          </div>
          {% endif %}
          {% if page.vulnerable_code and page.secure_code %}
          <!-- If we used the layout comparison, we might want a header here -->
          <h2>Technical Nuances & Deep Dive</h2>
          {% endif %}

          {{ content }}
        </div>

        <!-- Security Lab Footer -->
        <div class="security-footer">
          <hr>
          <h3>üõ°Ô∏è Security Audit Checklist</h3>
          <ul class="checklist">
            {% for check in page.checklist %}
            <li><input type="checkbox" disabled> {{ check }}</li>
            {% endfor %}
          </ul>
        </div>

        <a class="u-url" href="{{ page.url | relative_url }}" hidden></a>
      </article>
    </div>
  </main>

  {% include footer.html %}

</body>

</html>