/**
 * EXPLOIT TEST: TOCTOU Race Condition (Pinocchio)
 * 
 * This test demonstrates that the vulnerable Pinocchio interface expects 6 accounts,
 * including a `callback_program` that is checked for logic reuse, enabling reentrancy checks.
 */

import {
    Connection,
    Keypair,
    PublicKey,
    Transaction,
    TransactionInstruction,
    SystemProgram,
    sendAndConfirmTransaction,
} from "@solana/web3.js";
import {
    createMint,
    createAccount,
    TOKEN_PROGRAM_ID
} from "@solana/spl-token";

describe("08-toctou-race-condition: Pinocchio Exploit", () => {
    const connection = new Connection("http://localhost:8899", "confirmed");
    const PROGRAM_ID = new PublicKey("VULN8toctouVa11d1d1d1d1d1d1d1d1d1d1d1d1d1");

    it("Accepts callback_program in account list", async () => {
        console.log("\nüéØ EXPLOIT: TOCTOU Race Condition (Pinocchio)\n");

        const user = Keypair.generate();
        const airdropSig = await connection.requestAirdrop(user.publicKey, 1000000000);
        await connection.confirmTransaction(airdropSig);

        const [vaultPda] = PublicKey.findProgramAddressSync([Buffer.from("vault")], PROGRAM_ID);
        const mint = await createMint(connection, user, user.publicKey, null, 6);
        const vaultTokenAccount = await createAccount(connection, user, mint, vaultPda);
        const userTokenAccount = await createAccount(connection, user, mint, user.publicKey);

        const fakeCallback = SystemProgram.programId;

        // Send transaction with 6 accounts (including callback)
        const data = Buffer.alloc(8);
        data.writeBigUInt64LE(BigInt(100), 0);

        const ix = new TransactionInstruction({
            keys: [
                { pubkey: user.publicKey, isSigner: true, isWritable: true },
                { pubkey: vaultPda, isSigner: false, isWritable: true },
                { pubkey: vaultTokenAccount, isSigner: false, isWritable: true },
                { pubkey: userTokenAccount, isSigner: false, isWritable: true },
                { pubkey: fakeCallback, isSigner: false, isWritable: false }, // üö® The vector
                { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
            ],
            programId: PROGRAM_ID,
            data: data,
        });

        try {
            await sendAndConfirmTransaction(connection, new Transaction().add(ix), [user]);
            console.log("‚úÖ Success: Transaction accepted with callback program.");
        } catch (e: any) {
            // Expect failure (InvalidAccountData/NotInitialized) but passing the interface check
            console.log("‚úÖ Transaction attempted. Error:", e.message);
            if (e.message.includes("NotEnoughAccountKeys")) {
                throw new Error("‚ùå FAIL: Program rejected account count (Check failed?)");
            }
        }
    });
});
